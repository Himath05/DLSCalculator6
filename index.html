<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DLS Debugger v2</title>
    
    <script src="https://cjrtnc.leaningtech.com/3.0/cj3loader.js"></script>
    
    <style>
        /* RESET EVERYTHING */
        html, body {
            width: 100vw; height: 100vh;
            margin: 0; padding: 0;
            overflow: hidden;
            background-color: #000;
            touch-action: none; /* Disable Browser Gestures */
        }

        #cheerpj-display {
            width: 100%; height: 100%;
            display: block;
            touch-action: none;
        }

        /* DEBUG CONSOLE (Click-through enabled) */
        #debug-console {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100px;
            background: rgba(0, 50, 0, 0.8);
            color: #0f0; font-family: monospace; font-size: 14px;
            pointer-events: none; /* Let touches pass through this box */
            z-index: 10000;
        }
    </style>
</head>
<body>

    <div id="debug-console">Initializing Global Net...</div>
    <div id="cheerpj-display"></div>

    <script>
        // --- 1. SETUP LOGGER ---
        function log(msg) {
            var c = document.getElementById("debug-console");
            c.innerText = "> " + msg + "\n" + c.innerText.substring(0, 200);
        }

        // --- 2. START CHEERPJ ---
        cheerpjInit().then(function(){
            cheerpjCreateDisplay(-1, -1, document.getElementById('cheerpj-display'));
            cheerpjRunJar("/app/DLSCalculator6/DLSCalculator.jar", "");
            log("App Started. Waiting for Canvas...");
            
            // Start the "Global Net" immediately
            activateGlobalBridge();
        });

        // --- 3. THE GLOBAL NET BRIDGE ---
        function activateGlobalBridge() {
            // We listen to the WHOLE WINDOW, not just the element
            window.addEventListener("touchstart", handleGlobalTouch, {passive: false, capture: true});
            window.addEventListener("touchmove",  handleGlobalTouch, {passive: false, capture: true});
            window.addEventListener("touchend",   handleGlobalTouch, {passive: false, capture: true});
            
            log("Global Bridge ACTIVE on Window.");
        }

        function handleGlobalTouch(e) {
            // 1. Always stop scrolling/zooming
            if (e.cancelable) e.preventDefault();

            // 2. Find the Java Canvas (It might appear late, so we check every tap)
            var canvas = document.querySelector("canvas");
            if (!canvas) {
                log("WARN: Tap detected, but Canvas not found yet.");
                return;
            }

            var type = "";
            var touch = e.changedTouches[0];

            // 3. Map Touch -> Mouse
            if (e.type === "touchstart") type = "mousedown";
            if (e.type === "touchmove")  type = "mousemove";
            if (e.type === "touchend")   type = "mouseup";

            log("INPUT: " + type);

            // 4. Create and Dispatch Event
            var simEvent = new MouseEvent(type, {
                bubbles: true, cancelable: true, view: window,
                screenX: touch.screenX, screenY: touch.screenY,
                clientX: touch.clientX, clientY: touch.clientY,
                button: 0, buttons: 1
            });

            canvas.dispatchEvent(simEvent);

            // 5. Special Case: Click on TouchEnd
            if (type === "mouseup") {
                var clickEvent = new MouseEvent("click", {
                    bubbles: true, cancelable: true, view: window,
                    screenX: touch.screenX, screenY: touch.screenY,
                    clientX: touch.clientX, clientY: touch.clientY,
                    button: 0, buttons: 1
                });
                canvas.dispatchEvent(clickEvent);
                log("INPUT: click (simulated)");
            }
        }
    </script>
</body>
</html>