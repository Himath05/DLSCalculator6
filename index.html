<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DLS Debugger</title>
    
    <script src="https://cjrtnc.leaningtech.com/3.0/cj3loader.js"></script>
    
    <style>
        html, body {
            height: 100%; width: 100%; margin: 0; padding: 0;
            overflow: hidden; background-color: #333;
            touch-action: none; user-select: none; -webkit-user-select: none;
        }

        #cheerpj-display {
            width: 100%; height: 100%; display: block;
            touch-action: none; cursor: pointer;
        }

        /* THE DEBUG CONSOLE (Visual Log on Screen) */
        #debug-console {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 150px;
            background: rgba(0, 0, 0, 0.8);
            color: #0f0;
            font-family: monospace;
            font-size: 12px;
            overflow-y: scroll;
            pointer-events: none; /* Let touches pass through it */
            z-index: 9999;
            padding: 5px;
            border-bottom: 2px solid #fff;
        }
    </style>
</head>
<body>

    <div id="debug-console">Waiting for logs...</div>

    <div id="cheerpj-display"></div>

    <script>
        // Logger Function
        function log(msg) {
            var c = document.getElementById("debug-console");
            c.innerHTML = "> " + msg + "<br>" + c.innerHTML;
        }

        cheerpjInit().then(function(){
            log("CheerpJ Initialized.");
            
            cheerpjCreateDisplay(-1, -1, document.getElementById('cheerpj-display'));
            log("Display Created.");

            cheerpjRunJar("/app/DLSCalculator6/DLSCalculator.jar", "");
            log("JAR Started. Looking for Canvas...");

            // Start looking for the Java window
            waitForCanvas();
        });

        function waitForCanvas() {
            // CheerpJ creates a generic <canvas> element
            var canvas = document.querySelector("canvas");
            
            if (canvas) {
                log("SUCCESS: Java Canvas Found!");
                canvas.style.touchAction = "none"; // Enforce no scrolling
                attachTouchBridge(canvas);
            } else {
                log("...searching for canvas...");
                setTimeout(waitForCanvas, 500);
            }
        }

        function attachTouchBridge(target) {
            log("Bridge Attached to: " + target.tagName);

            function dispatch(type, t) {
                // Create the fake mouse event
                var e = new MouseEvent(type, {
                    view: window,
                    bubbles: true,
                    cancelable: true,
                    screenX: t.screenX, screenY: t.screenY,
                    clientX: t.clientX, clientY: t.clientY,
                    button: 0, buttons: 1
                });
                
                // Send it to the Canvas
                target.dispatchEvent(e);
                log("SIMULATED: " + type + " at " + Math.round(t.clientX) + "," + Math.round(t.clientY));
            }

            // 1. TOUCH START
            target.addEventListener("touchstart", function(e) {
                e.preventDefault();
                log("TOUCH: Start detected");
                var t = e.changedTouches[0];
                
                // Focus the window (Java sometimes sleeps without focus)
                window.focus();
                target.focus();

                dispatch("mousedown", t);
            }, {passive: false});

            // 2. TOUCH MOVE
            target.addEventListener("touchmove", function(e) {
                e.preventDefault();
                var t = e.changedTouches[0];
                dispatch("mousemove", t);
            }, {passive: false});

            // 3. TOUCH END
            target.addEventListener("touchend", function(e) {
                e.preventDefault();
                log("TOUCH: End detected");
                var t = e.changedTouches[0];
                dispatch("mouseup", t);
                dispatch("click", t);
            }, {passive: false});
        }
    </script>
</body>
</html>