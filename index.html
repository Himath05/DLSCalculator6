<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DLS Calculator</title>
    
    <script src="https://cjrtnc.leaningtech.com/3.0/cj3loader.js"></script>
    
    <style>
        /* APP LAYOUT */
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #333;
            /* DISABLE SYSTEM GESTURES */
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        #cheerpj-display {
            width: 100%;
            height: 100%;
            display: block;
            touch-action: none;
        }
    </style>
</head>
<body>

    <div id="cheerpj-display"></div>

    <script>
        cheerpjInit().then(function(){
            // 1. Setup Screen
            cheerpjCreateDisplay(-1, -1, document.getElementById('cheerpj-display'));

            // 2. Run App (Using your working path)
            cheerpjRunJar("/app/DLSCalculator6/DLSCalculator.jar", "");

            // 3. START THE BRIDGE (Robust Mode)
            // This function keeps checking until the Java Canvas appears
            waitForCanvas();
        });

        // --- ROBUST TOUCH BRIDGE ---
        function waitForCanvas() {
            // CheerpJ creates a <canvas> element. We need to find it.
            var canvas = document.querySelector("canvas");
            
            if (canvas) {
                console.log("Java Canvas Found! Attaching Touch Bridge...");
                attachTouchBridge(canvas);
            } else {
                // If not found yet, check again in 0.5 seconds
                setTimeout(waitForCanvas, 500);
            }
        }

        function attachTouchBridge(targetElement) {
            
            function dispatchMouseEvent(type, touch) {
                var mouseEvent = new MouseEvent(type, {
                    view: window,
                    bubbles: true,
                    cancelable: true,
                    screenX: touch.screenX,
                    screenY: touch.screenY,
                    clientX: touch.clientX,
                    clientY: touch.clientY,
                    button: 0,
                    buttons: 1
                });
                targetElement.dispatchEvent(mouseEvent);
            }

            // 1. TOUCH START -> MOUSE DOWN
            targetElement.addEventListener("touchstart", function(e) {
                e.preventDefault(); // Stop scrolling
                var touch = e.changedTouches[0];
                dispatchMouseEvent("mousedown", touch);
            }, {passive: false});

            // 2. TOUCH MOVE -> MOUSE MOVE
            targetElement.addEventListener("touchmove", function(e) {
                e.preventDefault();
                var touch = e.changedTouches[0];
                dispatchMouseEvent("mousemove", touch);
            }, {passive: false});

            // 3. TOUCH END -> MOUSE UP + CLICK
            targetElement.addEventListener("touchend", function(e) {
                e.preventDefault();
                var touch = e.changedTouches[0];
                dispatchMouseEvent("mouseup", touch);
                // CRITICAL: Some Java buttons only work on "click", not just "mouseup"
                dispatchMouseEvent("click", touch); 
            }, {passive: false});
        }
    </script>
</body>
</html>